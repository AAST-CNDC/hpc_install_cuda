---
###Play book installs the cuda driver, and toolkit to node
#### Join AD fro https://zerosandones.us/2023/01/06/join-linux-to-active-directory/
- name: Install and configure CUDA, and toolkit
  become: true
  gather_facts: true
  hosts: all
  vars:
          HOSTIP: "{{ ansible_default_ipv4.address }}"
  tasks:
    - name: Update hosts file
      lineinfile:
              path: /etc/hosts
              line: "{{ HOSTIP }} {{ inventory_hostname }}"
              state: present

    - name: Resize ubuntu-lv volume to the max size
      lvol:
              vg: ubuntu-vg
              lv: ubuntu-lv
              size: +100%FREE
              resizefs: yes

    - name: Set node hostname
      ansible.builtin.hostname:
              name: "{{ inventory_hostname }}"

    - name: Install realme packages
      apt:
              name: 
               - realmd 
               - sssd 
               - libnss-sss 
               - libpam-sss
              state: present
              update_cache: yes

    - name: Discover student.aast.edu domain
      command: realm discover {{ ADDOMAIN }}

    - name: Join student AD Domain
      command:  realm join {{ ADDOMAIN }} --install=/ -U {{ ADUSER }}%{{ ADPASS }}
      register: join_result
      ignore_errors: yes

    - name: Check the AD join result
      fail:
               msg: "Unable to join the AD domain, {{ join_result.stderr }}"
      when: join_result.rc != 0

    - name: Disable GPO
      lineinfile:
               path: /etc/sssd/sssd.conf
               line: ad_gpo_access_control = permissive
               state: present

    - name: Restart SSSD service
      service:
               name: sssd
               state: restarted
               enabled: yes

    - name: Validate the AD join
      command: getent passwd {{ ADUSER }}
      register: validate_result
      ignore_errors: yes

    - name: Check the validation result
      fail:
              msg: "AD join validation failed, {{ validate_result.stderr }}"
      when: validate_result.rc != 0

    - meta: end_play

    - name: Block novueau 
      lineinfile:
        path: /etc/modprobe.d/blacklist-nouveau.conf
        line: options nouveau modeset=0
        state: present
        create: true

    - name: Update init ramfs
      shell: update-initramfs -u

    - name: Reboot the server
      shell: "sleep 5 && reboot"
      async: 1
      poll: 0

    - name: Wait for the host to boot
      wait_for:
        port: 22
        host: "{{ inventory_hostname }}"
        delay: 60
        timeout: 120
      connection: local

    - name: Install needed packages
      apt:
        name:
          - pkg-config
          - libglvnd-dev
          - gcc 
          - g++
          - default-jre 
          - make
        state: present
        update_cache: yes

    - name: Copy driver, and toolkit
      copy:
        src: files/{{ item }}
        dest: /home/administrator
        mode: 0555
      loop:
        - "{{ DRIVERNAME }}"
        - "{{ TOOLKITNAME }}"

    - name: Install nvidia driver
      shell: "/home/administrator/{{ DRIVERNAME }} -s"

    - name: Install nvidia toolkit
      shell: "/home/administrator/{{ TOOLKITNAME }} --toolkit --samples --silent"

    - name: Adding path
      lineinfile:
        path: /etc/profile
        line: "PATH=${PATH}:/{{ CUDADIR }}"
        state: present

